---
layout: post
status: publish
published: true
title: On El Capitan, bash, and history
author:
  display_name: diegor
  login: diegor
  email: me@diegor.it
  url: http://www.diegor.it
author_login: diegor
author_email: me@diegor.it
author_url: http://www.diegor.it
wordpress_id: 3659
wordpress_url: http://www.diegor.it/?p=3659
date: '2015-07-13 08:53:09 +0000'
date_gmt: '2015-07-13 07:53:09 +0000'
categories:
- osx
- environment
- apple
tags:
- osx
- bash
- el capitan
comments: []
---
<p>As explained in this <a href="http://www.reddit.com/r/osx/comments/397uep/changes_to_bash_sessions_and_terminal_in_el/">reddit</a>, Apple made some changed for the bash users especially on saving bash sessions/histor. Whenever a user exits, it saves the history in ~/.bash_sessions/ directory. Until here, nothing strage until you don't play with&nbsp;HISTFILESIZE and&nbsp;HISTSIZE environment variables.</p>
<p>In /etc/bash_bashrc_Apple_Terminal (which is called by /etc/bashrc), the following piece of code can cause some issues when you have set&nbsp;HISTFILESIZE and&nbsp;HISTSIZE to a very high values:</p>
<pre>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;# Save new history commands.<br />
&nbsp; &nbsp; &nbsp; &nbsp; if [ $BASH_SESSION_HISTORY -eq 1 ]; then<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; history -a<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cat "$BASH_SESSION_HISTFILE_NEW" >> "$BASH_SHARED_HISTFILE"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cat "$BASH_SESSION_HISTFILE_NEW" >> "$BASH_SESSION_HISTFILE"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Empty this session's history file to keep track of<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # which commands have already been copied.<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : >| "$BASH_SESSION_HISTFILE_NEW"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Read/write the files via the history command so they<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # are truncated as appropriate.<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; history -r "$BASH_SHARED_HISTFILE"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; history -w "$BASH_SHARED_HISTFILE"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; history -r "$BASH_SESSION_HISTFILE"<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; history -w "$BASH_SESSION_HISTFILE"<br />
&nbsp; &nbsp; &nbsp; &nbsp; fi<br />
</pre><br />
I had the HIST* variables set as:</p>
<pre>HISTFILESIZE=1000000000<br />
HISTSIZE=1000000<br />
</pre><br />
and this is what happened when I logout from the shell.</p>
<pre>leonard:~ diegor$ logout<br />
+ bash_update_session_state<br />
+ bash_save_session_state<br />
+ '[' 1 -eq 1 ']'<br />
+ '[' -n /Users/diegor/.bash_sessions/97360883-85FB-4463-A9DF-1246FCD05977.session ']'<br />
+ echo -n Saving session...<br />
Saving session...++ date<br />
+ echo echo Restored session: Mon Jul 13 08:23:07 BST 2015<br />
+ declare -F bash_session_save_state<br />
+ '[' 1 -eq 1 ']'<br />
+ history -a<br />
+ cat /Users/diegor/.bash_sessions/97360883-85FB-4463-A9DF-1246FCD05977.historynew<br />
+ cat /Users/diegor/.bash_sessions/97360883-85FB-4463-A9DF-1246FCD05977.historynew<br />
+ :<br />
+ history -r /Users/diegor/.bash_history<br />
</pre><br />
Looking at the help of history, it is stated:</p>
<pre>The `-w' option writes out the current history to the history file;<br />
`-r' means to read the file and append the contents to the history list instead.<br />
</pre></p>
<p>which means: if you HIST*SIZE are very high, the size is going to grow a lot, with some implications (see three bullet points below)</p>
<p>At this point you observe the following things:</p>
<ul>
<li>the terminal is stuck on "Saving session..."</li>
<li>CPU usage goes high (you have to kill the bash process from another shell or System Monitor)</li>
<li>the size of ~/.bash_session is increasing overtime: every time you logout it increases by the size of the history file (in my case was 20MB)</li><br />
</ul><br />
My suggestion is <strong>NOT to set those variables</strong> and let OSX deal with them.</p>
<p>IHTH</p>
